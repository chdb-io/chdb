name: Build & Test macOS x86_64

on:
  workflow_dispatch:
    inputs:
      TAG_NAME:
        description: 'Release Version Tag'
        required: true
      DEBUG_MODE:
        description: 'Enable debug mode (Debug build, lldb tests, skip static lib)'
        required: false
        default: 'true'
        type: boolean
  release:
    types: [created]
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
    paths-ignore:
      - '**/*.md'

env:
  # DEBUG_MODE disabled for all builds
  EFFECTIVE_DEBUG_MODE: 'false'

jobs:
  build_universal_wheel_on_linux:
    name: Build on Linux (cross-compile for macOS x86_64)
    runs-on: [self-hosted, linux, x64, ubuntu-latest]
    if: ${{ !github.event.pull_request.draft }}
    timeout-minutes: 600
    steps:
      - name: Install Python build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \
            libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm \
            libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev \
            libffi-dev liblzma-dev p7zip-full
      - name: Upgrade Rust toolchain
        run: |
          rustup toolchain install nightly-2025-07-07
          rustup default nightly-2025-07-07
          rustup component add rust-src
          rustc --version
          cargo --version
      - name: Install clang++ for Ubuntu
        run: |
          pwd
          uname -a
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19
          which clang++-19
          clang++-19 --version
          sudo apt-get install -y make cmake ccache ninja-build yasm gawk wget
          # Install WebAssembly linker (wasm-ld)
          sudo apt-get install -y lld-19
          # Create symlink for wasm-ld
          if ! command -v wasm-ld &> /dev/null; then
            sudo ln -sf /usr/bin/wasm-ld-19 /usr/bin/wasm-ld || true
          fi
          which wasm-ld || echo "wasm-ld not found in PATH"
          ccache -s
      - name: Update git
        run: |
          sudo add-apt-repository ppa:git-core/ppa -y
          sudo apt-get update
          sudo apt-get install -y git
          git --version
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Update submodules
        run: |
          git submodule update --init --recursive --jobs 4
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ubuntu-22.04-x86_64-cross-compile
          max-size: 5G
          append-timestamp: true
      - name: remove old clang and link clang-19 to clang
        run: |
          sudo rm -f /usr/bin/clang || true
          sudo ln -s /usr/bin/clang-19 /usr/bin/clang
          sudo rm -f /usr/bin/clang++ || true
          sudo ln -s /usr/bin/clang++-19 /usr/bin/clang++
          which clang++
          clang++ --version
      - name: Run chdb/build_mac_on_linux.sh
        timeout-minutes: 600
        run: |
          source ~/.cargo/env
          bash ./chdb/build_mac_on_linux.sh x86_64 Release
        continue-on-error: false
      - name: Run chdb/build/build_static_lib_mac_on_linux.sh
        if: env.EFFECTIVE_DEBUG_MODE != 'true'
        timeout-minutes: 600
        run: |
          source ~/.cargo/env
          bash ./chdb/build/build_static_lib_mac_on_linux.sh x86_64 Release
      #   continue-on-error: false
      - name: Check ccache statistics
        run: |
          ccache -s
          ls -lh chdb
          df -h
      - name: Keep killall ccache and wait for ccache to finish
        if: always()
        run: |
          sleep 60
          while ps -ef | grep ccache | grep -v grep; do \
            killall ccache; \
            sleep 10; \
          done
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-build-artifacts
          path: |
            ./libchdb.so
            ./libchdb.a
            ./chdb/_chdb.abi3.so
            ./chdb/libpybind11nonlimitedapi_stubs.dylib
            ./chdb/libpybind11nonlimitedapi_chdb_3.9.dylib
            ./chdb/libpybind11nonlimitedapi_chdb_3.10.dylib
            ./chdb/libpybind11nonlimitedapi_chdb_3.11.dylib
            ./chdb/libpybind11nonlimitedapi_chdb_3.12.dylib
            ./chdb/libpybind11nonlimitedapi_chdb_3.13.dylib
            ./chdb/libpybind11nonlimitedapi_chdb_3.14.dylib
          retention-days: 1

  test_on_macos:
    name: Test on macOS x86_64
    runs-on: macos-15-intel
    needs: build_universal_wheel_on_linux
    if: ${{ !github.event.pull_request.draft }}
    timeout-minutes: 600
    steps:
      - name: Check machine architecture
        run: |
          echo "=== Machine Architecture Information ==="
          echo "Machine type: $(uname -m)"
          echo "Architecture: $(arch)"
          echo "System info: $(uname -a)"
          echo "Hardware info:"
          system_profiler SPHardwareDataType | grep "Chip\|Processor"
          if sysctl -n hw.optional.arm64 2>/dev/null | grep -q "1"; then
            echo "This is an ARM64 (Apple Silicon) machine"
          else
            echo "This is an x86_64 (Intel) machine"
          fi
      - name: Setup pyenv
        run: |
          curl https://pyenv.run | bash
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"

          pyenv install 3.9:latest
          pyenv install 3.10:latest
          pyenv install 3.11:latest
          pyenv install 3.12:latest
          pyenv install 3.13:latest
          pyenv install 3.14:latest
          pyenv global 3.9 3.10 3.11 3.12 3.13 3.14

          echo "Installed versions:"
          pyenv versions
      - name: Verify pyenv installations
        run: |
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          echo "Installed Python versions:"
          pyenv versions
          echo ""
          echo "Verifying all required Python versions are available:"
          for version in 3.9 3.10 3.11 3.12 3.13 3.14; do
            if ! pyenv versions --bare | grep -q "^$version"; then
              echo "ERROR: Python $version is not installed!"
              exit 1
            fi
            echo "âœ“ Python $version is installed"
          done
          echo "All Python versions verified successfully!"
      - name: Install dependencies for all Python versions
        run: |
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          for version in 3.9 3.10 3.11 3.12 3.13 3.14; do
            echo "Installing dependencies for Python $version"
            pyenv shell $version
            python -m pip install --upgrade pip
            python -m pip install setuptools tox "pandas<3.0" pyarrow twine psutil deltalake wheel>=0.40.0 jupyter nbconvert
            pyenv shell --unset
          done
      - name: Remove /usr/local/bin/python3
        run: |
          sudo rm -f /usr/local/bin/python3
      - name: Install go for macOS
        run: |
          brew update
          brew install go
          go version
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64-build-artifacts
          path: ./artifacts
      - name: Restore artifacts to original paths
        run: |
          mv ./artifacts/libchdb.so ./
          # Move libchdb.a if it exists (not built in DEBUG_MODE)
          [ -f ./artifacts/libchdb.a ] && mv ./artifacts/libchdb.a ./
          mv ./artifacts/chdb/_chdb.abi3.so ./chdb/
          mv ./artifacts/chdb/libpybind11nonlimitedapi_stubs.dylib ./chdb/
          for v in 9 10 11 12 13 14; do
            mv ./artifacts/chdb/libpybind11nonlimitedapi_chdb_3.${v}.dylib ./chdb/
          done
          ls -lh ./libchdb.so
          ls -lh ./chdb/*.so ./chdb/*.dylib
      - name: Sign macOS binaries
        run: |
          echo "Signing cross-compiled binaries for macOS..."
          codesign -f -s - ./libchdb.so
          codesign -f -s - ./chdb/_chdb.abi3.so
          codesign -f -s - ./chdb/libpybind11nonlimitedapi_stubs.dylib
          for f in ./chdb/libpybind11nonlimitedapi_chdb_3.*.dylib; do
            codesign -f -s - "$f"
          done
          echo "Verifying signatures..."
          codesign -dvv ./libchdb.so
          codesign -dvv ./chdb/_chdb.abi3.so
      - name: Run chdb/build/test_go_example.sh
        timeout-minutes: 600
        run: |
          bash ./chdb/build/test_go_example.sh ${{ github.workspace }}/libchdb.a
        continue-on-error: true
        id: go_test
      - name: Fail if Go test crashed
        if: steps.go_test.outcome == 'failure'
        run: |
          echo "Go test failed - crash info should be printed above by test_go_example.sh"
          exit 1