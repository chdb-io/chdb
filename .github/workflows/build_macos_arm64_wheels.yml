name: Build macOS arm64

on:
  workflow_dispatch:
    inputs:
      TAG_NAME:
        description: 'Release Version Tag'
        required: true
  release:
    types: [created]
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
    paths-ignore:
      - '**/*.md'

jobs:
  build_universal_wheel:
    name: Build Universal Wheel (macOS ARM64)
    runs-on: macos-14-xlarge
    # if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Free up disk space (Initial)
        run: |
          # Clean Homebrew cache
          brew cleanup -s 2>/dev/null || true
          rm -rf "$(brew --cache)" 2>/dev/null || true
          sudo rm -rf ~/Library/Developer/Xcode/DerivedData 2>/dev/null || true
          sudo rm -rf ~/Library/Caches/com.apple.dt.Xcode 2>/dev/null || true
          sudo rm -rf /Users/runner/Library/Android 2>/dev/null || true
          sudo rm -rf /tmp/* 2>/dev/null || true
          echo "=== Disk usage after cleanup ==="
          df -h
      - name: Setup pyenv
        run: |
          curl https://pyenv.run | bash
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"

          pyenv install 3.8:latest
          pyenv install 3.9:latest
          pyenv global 3.8
          pyenv global 3.9

          echo "Installed versions:"
          pyenv versions
      - name: Install dependencies for all Python versions
        run: |
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          for version in 3.9; do
            echo "Installing dependencies for Python $version"
            pyenv shell $version
            python -m pip install --upgrade pip
            python -m pip install setuptools wheel tox pandas pyarrow twine psutil deltalake wheel>=0.40.0 jupyter nbconvert
            pyenv shell --unset
          done
      - name: Remove /usr/local/bin/python3
        run: |
          sudo rm -f /usr/local/bin/python3
      - name: Install clang++ for macOS
        run: |
          pwd
          uname -a
          export HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
          brew update
          brew install ca-certificates lz4 mpdecimal readline sqlite xz z3 zstd
          brew install openssl@3 || echo "OpenSSL install failed, continuing..."
          brew install --ignore-dependencies llvm@19
          brew install git ninja libtool gettext binutils grep findutils nasm lld@19 libiconv
          brew install ccache || echo "ccache installation failed, continuing without it"
          brew install go
          cd /usr/local/opt/ && sudo rm -f llvm && sudo ln -sf llvm@19 llvm
          export PATH=$(brew --prefix llvm@19)/bin:$(brew --prefix lld@19)/bin:$PATH
          which clang++
          clang++ --version
          which wasm-ld || echo "wasm-ld not found in PATH"
          which go
          go version
          ccache -s | echo "ccache not available yet"
      - name: Upgrade Rust toolchain
        run: |
          rustup toolchain install nightly-2025-07-07
          rustup default nightly-2025-07-07
          rustup component add rust-src
          rustc --version
          cargo --version
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Update submodules
        run: |
          git submodule update --init --recursive --jobs 4
      - name: Free up disk space (Before compilation)
        run: |
          echo "=== Disk usage before compilation cleanup ==="
          df -h
          # Remove Xcode (huge, ~15GB+)
          sudo rm -rf /Applications/Xcode.app || true
          sudo rm -rf /Applications/Xcode_*.app || true
          # Remove iOS/tvOS/watchOS simulators
          sudo rm -rf ~/Library/Developer/CoreSimulator || true
          sudo rm -rf /Library/Developer/CoreSimulator || true
          # Remove Android SDK
          sudo rm -rf ~/Library/Android || true
          sudo rm -rf /usr/local/lib/android || true
          # Remove .NET SDK
          sudo rm -rf /usr/local/share/dotnet || true
          # Remove PowerShell
          sudo rm -rf /usr/local/share/powershell || true
          # Remove Chromium/Chrome for testing
          sudo rm -rf /usr/local/share/chromium || true
          sudo rm -rf ~/Library/Caches/Google || true
          # Remove Swift toolchains
          sudo rm -rf /Library/Developer/Toolchains || true
          # Remove other large directories
          sudo rm -rf /usr/local/lib/node_modules || true
          sudo rm -rf ~/.dotnet || true
          sudo rm -rf ~/hostedtoolcache || true
          # Homebrew cleanup
          brew cleanup -s 2>/dev/null || true
          rm -rf "$(brew --cache)" 2>/dev/null || true
          rm -rf ~/.cache/pip 2>/dev/null || true
          rm -rf ~/.pyenv/.cache 2>/dev/null || true
          rm -rf ~/.cargo/registry/cache 2>/dev/null || true
          echo "=== Disk usage after cleanup ==="
          df -h
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-arm64-ccache
          max-size: 5G
          append-timestamp: true
      - name: Run chdb/build.sh
        timeout-minutes: 600
        run: |
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          source ~/.cargo/env
          pyenv shell 3.8
          export PATH=$(brew --prefix llvm@19)/bin:$(brew --prefix lld@19)/bin:/usr/local/opt/grep/libexec/gnubin:/usr/local/opt/binutils/bin:$PATH:/usr/local/opt/findutils/libexec/gnubin
          export CC=$(brew --prefix llvm@19)/bin/clang
          export CXX=$(brew --prefix llvm@19)/bin/clang++
          bash gen_manifest.sh
          bash ./chdb/build.sh RelWithDebInfo
      - name: Setup core dump collection
        run: |
          mkdir -p tmp/core
          sudo sysctl kern.corefile=$PWD/tmp/core/core.%P
          sudo sysctl kern.coredump=1
          ulimit -c unlimited
      - name: Free up disk space
        run: |
          # Keep buildlib/src, buildlib/base, buildlib/contrib for debug info (.o files)
          rm -rf buildlib/*.so 2>/dev/null || true
          df -h
      - name: Test wheel on all Python versions
        run: |
          ulimit -c unlimited
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          pyenv shell 3.9
          export PYTHONPATH=$PWD
          for i in $(seq 1 5000); do
            echo "=== Test iteration $i/5000 on Python 3.9 ==="
            make test
          done
          pyenv shell --unset
        continue-on-error: false
      - name: Check and upload core files if present
        if: always()
        run: |
          if ls tmp/core/core.* >/dev/null 2>&1; then
            echo "CORE_FILES_FOUND=true" >> $GITHUB_ENV
            echo "=== Core files found, analyzing with lldb ==="
            CHDB_SO="chdb/_chdb.abi3.so"
            echo "Using chdb library: $CHDB_SO"
            for corefile in tmp/core/core.*; do
              echo "=== Analyzing $corefile ==="
              lldb "$CHDB_SO" -c "$corefile" -o "bt" -o "quit" 2>&1 || true
              echo "=== End of $corefile analysis ==="
            done
            tar -czvf core-files-macos-arm64.tar.gz tmp/core/core.*
            echo "Core files tar created: core-files-macos-arm64.tar.gz"
            ls -lh core-files-macos-arm64.tar.gz
          else
            echo "CORE_FILES_FOUND=false" >> $GITHUB_ENV
            echo "No core files found in tmp/core"
          fi
        continue-on-error: true
      - name: Keep killall ccache and wait for ccache to finish
        if: always()
        run: |
          sleep 60
          while ps -ef | grep ccache | grep -v grep; do \
            killall ccache; \
            sleep 10; \
          done
