name: Build Linux x86_64

on:
  workflow_dispatch:
    inputs:
      TAG_NAME:
        description: 'Release Version Tag'
        required: true
  release:
    types: [created]
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
    paths-ignore:
      - '**/*.md'


jobs:
  build_universal_wheel:
    name: Build Universal Wheel (Linux x86_64)
    runs-on: [self-hosted, linux, x64, ubuntu-latest]
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Install Python build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \
            libbz2-dev libreadline-dev wget curl llvm \
            libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev \
            libffi-dev liblzma-dev libsqlite3-dev golang-go
      - name: Install GitHub CLI
        run: |
          wget https://github.com/cli/cli/releases/download/v2.82.1/gh_2.82.1_linux_amd64.tar.gz -O gh.tar.gz
          tar -xf gh.tar.gz
          sudo cp gh_*/bin/gh /usr/local/bin/
          sudo chmod +x /usr/local/bin/gh
          if ! gh --version; then
            echo "ERROR: GitHub CLI installation failed!"
            exit 1
          fi
          echo "GitHub CLI installed successfully"
      - name: Setup pyenv
        run: |
          # Remove existing pyenv installation if present
          rm -rf $HOME/.pyenv
          curl https://pyenv.run | bash
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          pyenv install 3.8:latest
          pyenv install 3.9:latest
          pyenv install 3.10:latest
          pyenv install 3.11:latest
          pyenv install 3.12:latest
          pyenv install 3.13:latest
          pyenv install 3.14:latest
          pyenv global 3.8 3.9 3.10 3.11 3.12 3.13 3.14

          # Verify installations
          echo "Installed versions:"
          pyenv versions
      - name: Install dependencies for all Python versions
        run: |
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          for version in 3.8 3.9 3.10 3.11 3.12 3.13 3.14; do
            echo "Installing dependencies for Python $version"
            pyenv shell $version
            python -m pip install --upgrade pip
            python -m pip install setuptools tox pandas pyarrow twine psutil deltalake wheel jupyter nbconvert
            pyenv shell --unset
          done
      - name: Upgrade Rust toolchain
        run: |
          rustup toolchain install nightly-2025-07-07
          rustup default nightly-2025-07-07
          rustup component add rust-src
          rustc --version
          cargo --version
      - name: Install clang++ for Ubuntu
        run: |
          pwd
          uname -a
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19
          which clang++-19
          clang++-19 --version
          sudo apt-get install -y make cmake ccache ninja-build yasm gawk wget
          # Install WebAssembly linker (wasm-ld)
          sudo apt-get install -y lld-19
          # Create symlink for wasm-ld
          if ! command -v wasm-ld &> /dev/null; then
            sudo ln -sf /usr/bin/wasm-ld-19 /usr/bin/wasm-ld || true
          fi
          which wasm-ld || echo "wasm-ld not found in PATH"
          ccache -s
      - name: Update git
        run: |
          sudo add-apt-repository ppa:git-core/ppa -y
          sudo apt-get update
          sudo apt-get install -y git
          git --version
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Update submodules
        run: |
          git submodule update --init --recursive --jobs 4
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ubuntu-22.04-x86_64
          max-size: 5G
          append-timestamp: true
      - name: remove old clang and link clang-19 to clang
        run: |
          sudo rm -f /usr/bin/clang || true
          sudo ln -s /usr/bin/clang-19 /usr/bin/clang
          sudo rm -f /usr/bin/clang++ || true
          sudo ln -s /usr/bin/clang++-19 /usr/bin/clang++
          which clang++
          clang++ --version
      - name: Run chdb/build.sh
        timeout-minutes: 600
        run: |
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          source ~/.cargo/env
          pyenv shell 3.8
          export CC=/usr/bin/clang
          export CXX=/usr/bin/clang++
          bash ./chdb/build.sh
          pyenv shell 3.8
          bash -x ./chdb/test_smoke.sh
        continue-on-error: false
      - name: Check ccache statistics
        run: |
          ccache -s
          ls -lh chdb
          df -h
      - name: Build wheels
        run: |
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          export CC=/usr/bin/clang
          export CXX=/usr/bin/clang++
          pyenv shell 3.8
          make wheel
      - name: Install patchelf from github
        run: |
          wget https://github.com/NixOS/patchelf/releases/download/0.18.0/patchelf-0.18.0-x86_64.tar.gz -O patchelf.tar.gz
          tar -xvf patchelf.tar.gz
          sudo cp bin/patchelf /usr/bin/
          sudo chmod +x /usr/bin/patchelf
          patchelf --version
      - name: Audit wheels
        run: |
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init -)"
          pyenv shell 3.9
          python -m pip install auditwheel
          auditwheel -v repair -w dist/ --plat manylinux2014_x86_64 dist/*.whl
        continue-on-error: false
      - name: Show files
        run: |
          sudo rm -f dist/*-linux_x86_64.whl
          ls -lh dist
        shell: bash
      # - name: Setup core dump collection
      #   run: |
      #     mkdir -p tmp/core
      #     echo "tmp/core/core.%p" | sudo tee /proc/sys/kernel/core_pattern
      #     ulimit -c unlimited
      # - name: Test wheel on all Python versions
      #   run: |
      #     export PATH="$HOME/.pyenv/bin:$PATH"
      #     eval "$(pyenv init -)"
      #     for version in 3.8 3.9 3.10 3.11 3.12 3.13 3.14; do
      #       echo "Testing chdb on Python $version"
      #       pyenv shell $version
      #       python -m pip install dist/*.whl --force-reinstall
      #       python -c "import chdb; res = chdb.query('select 1112222222,555', 'CSV'); print(f'Python $version: {res}')"
      #       make test
      #       pyenv shell --unset
      #     done
      #   continue-on-error: false
      # - name: Check and upload core files if present
      #   if: always()
      #   run: |
      #     if ls tmp/core/core.* >/dev/null 2>&1; then
      #       echo "CORE_FILES_FOUND=true" >> $GITHUB_ENV
      #       tar -czvf core-files-linux-x86_64.tar.gz tmp/core/core.*
      #       echo "Core files tar created: core-files-linux-x86_64.tar.gz"
      #       ls -lh core-files-linux-x86_64.tar.gz
      #     else
      #       echo "CORE_FILES_FOUND=false" >> $GITHUB_ENV
      #       echo "No core files found in tmp/core"
      #     fi
      #   continue-on-error: true
      - name: Keep killall ccache and wait for ccache to finish
        if: always()
        run: |
          sleep 60
          while ps -ef | grep ccache | grep -v grep; do \
            killall ccache; \
            sleep 10; \
          done
      # - name: Upload core files artifact
      #   if: always() && env.CORE_FILES_FOUND == 'true'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: core-files-linux-x86_64
      #     path: core-files-linux-x86_64.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: chdb-artifacts-linux-x86_64
          path: |
            ./dist/*.whl
          overwrite: true
